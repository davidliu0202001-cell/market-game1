<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ‚æ¥µæ”¶éŠ€å“¡è¨“ç·´å™¨ Pro Max v3</title>
    <style>
        :root {
            --primary: #2e7d32;
            --blue: #1976d2;
            --purple: #7b1fa2;
            --bg: #f4f7f6;
        }
        body {
            font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .app-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 480px;
            text-align: center;
            position: relative;
        }
        .sound-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 1.2rem;
            border: none;
            padding: 5px;
            border-radius: 50%;
            background: #f0f0f0;
        }
        /* å“é …èª¿æ•´å™¨ */
        .settings-bar {
            background: #eceff1;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .qty-btn {
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
        }
        .mode-switch {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }
        .mode-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            background: #f8f9fa;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.3s;
        }
        .mode-btn.active {
            border-color: var(--purple);
            background: #f3e5f5;
            color: var(--purple);
        }
        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
            font-weight: bold;
            background: #f1f1f1;
            padding: 10px;
            border-radius: 10px;
        }
        .display-area {
            background: #f9fbe7;
            border: 2px dashed var(--primary);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.4rem;
            font-size: 1.1rem;
        }
        .total-info {
            text-align: right;
            font-weight: bold;
            color: #d32f2f;
            border-top: 1px solid #ccc;
            margin-top: 5px;
            font-size: 1.2rem;
        }
        .history-info {
            font-size: 1rem;
            color: #2e7d32;
            margin-bottom: 10px;
            background: #e8f5e9;
            padding: 8px;
            border-radius: 5px;
            display: block;
            font-weight: bold;
        }
        .highlight-box {
            background: #fff8e1;
            padding: 12px;
            border-radius: 10px;
            font-size: 1.3rem;
            margin-bottom: 1.2rem;
            border: 1px solid #ffe082;
            font-weight: bold;
        }
        input[type="number"] {
            width: 70%;
            padding: 10px;
            font-size: 1.8rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
        }
        .btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        .btn-check { background: var(--primary); }
        .btn-next { background: var(--blue); display: none; }
        .feedback { margin: 10px 0; font-weight: bold; font-size: 1.2rem; min-height: 1.5rem; }
        .step-tag {
            background: var(--purple);
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<div class="app-card">
    <button class="sound-toggle" onclick="toggleMute()" id="muteBtn">ğŸ”Š</button>

    <div class="settings-bar">
        <span>ğŸ“¦ å“é …æ•¸é‡é™åˆ¶ï¼š</span>
        <button class="qty-btn" onclick="adjustMaxItems(-1)">-</button>
        <span id="maxItemDisplay" style="width: 20px;">3</span>
        <button class="qty-btn" onclick="adjustMaxItems(1)">+</button>
    </div>

    <div class="mode-switch">
        <div class="mode-btn active" onclick="switchMode('change')">ğŸ’¸ æ‰¾éŒ¢</div>
        <div class="mode-btn" onclick="switchMode('calc')">ğŸœ ç®—å¸³</div>
        <div class="mode-btn" onclick="switchMode('mixed')">ğŸŒŸ é€²éšæ¨¡å¼</div>
    </div>

    <div class="stats-bar">
        <span>ğŸ† ç­”å°: <span id="score">0</span></span>
        <span>ğŸ”¥ é€£å‹: <span id="combo">0</span></span>
        <span>â³ <span id="seconds">0</span>s</span>
    </div>

    <h2 id="title" style="color: var(--primary); margin: 0.5rem 0;">æ‰¾éŒ¢å¤§æŒ‘æˆ°</h2>
    
    <div class="display-area" id="displayArea"></div>
    <div id="historyContainer"></div>
    <div class="highlight-box" id="promptText"></div>

    <input type="number" id="ansInput" placeholder="?" autocomplete="off">
    <div id="msg" class="feedback"></div>
    
    <button class="btn btn-check" id="checkBtn" onclick="verify()">é€å‡ºç­”æ¡ˆ</button>
    <button class="btn btn-next" id="nextBtn" onclick="initGame()">ä¸‹ä¸€é¡Œ âœ</button>
</div>

<audio id="sndCorrect" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
<audio id="sndWrong" src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></audio>

<script>
    const products = [
        { n: "ç‰›è‚‰éºµ", e: "ğŸœ", p: 130 }, { n: "ç‚¸é†¬éºµ", e: "ğŸ", p: 100 },
        { n: "ç‡™é’èœ", e: "ğŸ¥¬", p: 40 }, { n: "æ»·å‘³", e: "ğŸ¢", p: 65 },
        { n: "é®®ä¹³", e: "ğŸ¥›", p: 90 }, { n: "é›æ’", e: "ğŸ—", p: 85 },
        { n: "ç‚’é£¯", e: "ğŸš", p: 80 }, { n: "è²¢ä¸¸æ¹¯", e: "ğŸ¥£", p: 35 }
    ];

    let currentMode = 'change';
    let targetAnswer = 0;
    let score = 0, combo = 0, seconds = 0;
    let timerInterval;
    let isMuted = false;
    let maxItems = 3;
    
    let mixedStep = 1; 
    let mixedTotal = 0;
    let mixedPaid = 0;

    function adjustMaxItems(val) {
        maxItems = Math.max(1, Math.min(10, maxItems + val));
        document.getElementById('maxItemDisplay').innerText = maxItems;
        initGame();
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    }

    function switchMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        if(event) event.target.classList.add('active');
        const titles = { 'change': 'æ‰¾éŒ¢å¤§æŒ‘æˆ°', 'calc': 'ç®—å¸³å¤§æŒ‘æˆ°', 'mixed': 'æ”¶éŠ€å¤§å¸« (é€²éš)' };
        document.getElementById('title').innerText = titles[mode];
        initGame();
    }

    function playSound(type) {
        if(isMuted) return;
        const s = document.getElementById(type === 'correct' ? 'sndCorrect' : 'sndWrong');
        s.currentTime = 0;
        s.play().catch(() => {});
    }

    // ç”Ÿæˆä»˜æ¬¾é‡‘é¡é‚è¼¯ï¼šç¬¦åˆå°ç£å¯¦æ³
    function generatePaidAmount(total) {
        if (total === 0) return 0;
        const bills = [100, 200, 500, 1000];
        // å„ªå…ˆæ‰¾æœ€æ¥è¿‘çš„å¤§é¡éˆ”ç¥¨
        let paid = bills.find(b => b >= total);
        
        // å¦‚æœç¸½é¡å¾ˆå¤§ï¼Œå‰‡ä»¥ 500 æˆ– 1000 ç‚ºå–®ä½è·³
        if (!paid) {
            if (total > 1000) {
                paid = Math.ceil(total / 500) * 500;
            } else {
                paid = Math.ceil(total / 100) * 100;
            }
        }

        // 30% æ©Ÿç‡é¡§å®¢æœƒå¤šä»˜ä¸€é»ï¼ˆä¾‹å¦‚ç¸½åƒ¹ 120 ä»˜ 500 æˆ– 1000ï¼‰
        if (Math.random() > 0.7) {
            if (paid === 100) paid = 500;
            else if (paid <= 500) paid = 1000;
        }
        return paid;
    }

    function initGame() {
        clearInterval(timerInterval);
        seconds = 0;
        mixedStep = 1;
        document.getElementById('seconds').innerText = seconds;
        document.getElementById('msg').innerText = '';
        document.getElementById('ansInput').value = '';
        document.getElementById('ansInput').disabled = false;
        document.getElementById('checkBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('historyContainer').innerHTML = '';

        const display = document.getElementById('displayArea');
        display.innerHTML = '';

        let total = 0;
        const count = Math.floor(Math.random() * maxItems) + 1;

        if (currentMode === 'change') {
            for(let i=0; i<count; i++) {
                const item = products[Math.floor(Math.random()*products.length)];
                display.innerHTML += `<div class="item-row"><span>${item.e} ${item.n}</span><span>$${item.p}</span></div>`;
                total += item.p;
            }
            display.innerHTML += `<div class="total-info">ç¸½å…±ï¼š$${total}</div>`;
            const paid = generatePaidAmount(total);
            document.getElementById('promptText').innerText = `é¡§å®¢ä»˜äº†ï¼š${paid} å…ƒï¼Œè¦æ‰¾å¤šå°‘ï¼Ÿ`;
            targetAnswer = paid - total;
        } 
        else if (currentMode === 'calc') {
            for(let i=0; i<count; i++) {
                const item = products[Math.floor(Math.random()*products.length)];
                const q = Math.floor(Math.random() * 2) + 1;
                display.innerHTML += `<div class="item-row"><span>${item.e} ${item.n} ($${item.p})</span><span>x ${q}</span></div>`;
                total += (item.p * q);
            }
            document.getElementById('promptText').innerText = `è«‹å•ç¸½å…±å¤šå°‘éŒ¢ï¼Ÿ`;
            targetAnswer = total;
        } 
        else if (currentMode === 'mixed') {
            for(let i=0; i<count; i++) {
                const item = products[Math.floor(Math.random()*products.length)];
                const q = Math.floor(Math.random() * 2) + 1;
                display.innerHTML += `<div class="item-row"><span>${item.e} ${item.n} ($${item.p})</span><span>x ${q}</span></div>`;
                total += (item.p * q);
            }
            mixedTotal = total;
            mixedPaid = generatePaidAmount(total);
            document.getElementById('promptText').innerHTML = `<span class="step-tag">Step 1</span> ç®—å‡ºç¸½åƒ¹ï¼š`;
            targetAnswer = mixedTotal;
        }

        timerInterval = setInterval(() => { seconds++; document.getElementById('seconds').innerText = seconds; }, 1000);
        document.getElementById('ansInput').focus();
    }

    function verify() {
        const val = parseInt(document.getElementById('ansInput').value);
        if(isNaN(val)) return;

        const msg = document.getElementById('msg');

        if (currentMode === 'mixed' && mixedStep === 1) {
            if (val === targetAnswer) {
                playSound('correct');
                mixedStep = 2;
                document.getElementById('historyContainer').innerHTML = `<div class="history-info">âœ… ç¸½åƒ¹ç¢ºèªï¼š$${mixedTotal}</div>`;
                document.getElementById('ansInput').value = '';
                document.getElementById('promptText').innerHTML = `<span class="step-tag">Step 2</span> é¡§å®¢ä»˜äº† ${mixedPaid}ï¼Œæ‰¾å¤šå°‘ï¼Ÿ`;
                targetAnswer = mixedPaid - mixedTotal;
                msg.style.color = "blue";
                msg.innerText = "æ­£ç¢ºï¼æœ€å¾Œä¸€æ­¥ï¼šç®—æ‰¾éŒ¢ã€‚";
                document.getElementById('ansInput').focus();
                return;
            } else { fail(targetAnswer); }
        } else {
            if(val === targetAnswer) success(); else fail(targetAnswer);
        }
    }

    function success() {
        playSound('correct');
        score++; combo++;
        document.getElementById('msg').style.color = "green";
        document.getElementById('msg').innerText = `âœ… å¤ªæ£’äº†ï¼(${seconds}ç§’)`;
        finishRound();
    }

    function fail(correct) {
        playSound('wrong');
        combo = 0;
        document.getElementById('msg').style.color = "red";
        document.getElementById('msg').innerText = `âŒ ç®—éŒ¯å›‰ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${correct}`;
        finishRound();
    }

    function finishRound() {
        clearInterval(timerInterval);
        document.getElementById('score').innerText = score;
        document.getElementById('combo').innerText = combo;
        document.getElementById('ansInput').disabled = true;
        document.getElementById('checkBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'block';
        document.getElementById('nextBtn').focus();
    }

    document.getElementById('ansInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') verify(); });
    window.onload = initGame;
</script>
</body>
</html>