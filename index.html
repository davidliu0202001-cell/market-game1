<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½æ”¶éŠ€ç‹ - æ•¸é‡å¼·åŒ–ç‰ˆ</title>
    <style>
        :root {
            --primary: #2e7d32;
            --blue: #1976d2;
            --purple: #7b1fa2;
            --line-green: #06C755;
            --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 10px; margin: 0; }
        .app-card { background: white; padding: 1.2rem; border-radius: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15); width: 100%; max-width: 450px; text-align: center; display: none; position: relative; }
        #login-screen { background: white; padding: 2.5rem 1.5rem; border-radius: 1.5rem; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .social-btn { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .google { background: #fff; border: 1px solid #ddd; color: #555; }
        .fb { background: #1877F2; color: white; }
        .controls { background: #eceff1; padding: 10px; border-radius: 12px; margin-bottom: 15px; }
        .qty-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ccc; background: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .mode-switch { display: flex; gap: 5px; }
        .mode-btn { flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; background: #f8f9fa; font-size: 0.8rem; font-weight: bold; }
        .mode-btn.active { border-color: var(--purple); background: #f3e5f5; color: var(--purple); }
        .display-area { background: #f9fbe7; border: 2px dashed var(--primary); border-radius: 1rem; padding: 1rem; margin: 10px 0; text-align: left; min-height: 100px; }
        .item-row { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 5px; }
        .highlight-box { background: #fff8e1; padding: 12px; border-radius: 10px; font-size: 1.3rem; font-weight: bold; margin-bottom: 12px; border: 1px solid #ffe082; color: #333; }
        .shop-tag { display: inline-block; background: var(--blue); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; }
        input[type="number"] { width: 70%; padding: 10px; font-size: 1.8rem; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; text-align: center; }
        .btn { width: 100%; padding: 1rem; font-size: 1.1rem; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; color: white; margin-top: 5px; }
        .btn-check { background: var(--primary); }
        .btn-next { background: var(--blue); display: none; }
        .btn-share { background: var(--line-green); display: none; margin-top: 10px; }
        .sound-toggle { position: absolute; top: 10px; right: 10px; font-size: 1.4rem; border: none; background: none; cursor: pointer; }
        .history-info { font-size: 1rem; color: #2e7d32; background: #e8f5e9; padding: 8px; border-radius: 5px; margin-bottom: 8px; font-weight: bold; }
    </style>
</head>
<body>

<div id="login-screen">
    <h1 style="color: var(--primary); font-size: 1.8rem;">ğŸ® å…¨èƒ½æ”¶éŠ€ç‹</h1>
    <p>è¼¸å…¥æŒ‘æˆ°è€…åç¨±ï¼š</p>
    <input type="text" id="userNameInput" style="width: 80%; padding: 12px; font-size: 1.2rem; margin-bottom: 20px; border: 2px solid #ddd; border-radius: 8px;" placeholder="åª½åª½">
    <button class="social-btn google" onclick="fakeLogin()">Google ç™»å…¥</button>
    <button class="social-btn fb" onclick="fakeLogin()">Facebook ç™»å…¥</button>
</div>

<div class="app-card" id="game-screen">
    <button class="sound-toggle" onclick="toggleMute()" id="muteBtn">ğŸ”Š</button>
    
    <div class="controls">
        <div class="qty-row">
            <span>ğŸ“¦ å“é …æœ€å¤šï¼š</span>
            <button class="qty-btn" onclick="adjustMaxItems(-1)">-</button>
            <span id="maxItemDisplay" style="width: 20px;">2</span>
            <button class="qty-btn" onclick="adjustMaxItems(1)">+</button>
        </div>
        <div class="mode-switch">
            <button class="mode-btn" id="btn-calc" onclick="switchMode('calc')">åŠ ç¸½ç·´ç¿’</button>
            <button class="mode-btn" id="btn-change" onclick="switchMode('change')">æ‰¾é›¶ç·´ç¿’</button>
            <button class="mode-btn active" id="btn-mixed" onclick="switchMode('mixed')">ç¶œåˆé€²éš</button>
        </div>
    </div>

    <div style="font-weight: bold; color: #666; font-size: 0.9rem; margin-bottom: 5px;">æŒ‘æˆ°è€…ï¼š<span id="displayName"></span></div>
    
    <div class="stats-bar" style="display:flex; justify-content:space-around; background:#eee; padding:8px; border-radius:10px; font-size: 0.9rem; font-weight: bold;">
        <span>ğŸ† ç©åˆ†: <span id="score">0</span></span>
        <span>ğŸ”¥ é€£å‹: <span id="combo">0</span></span>
        <span>â³ <span id="seconds">0</span>s</span>
    </div>

    <div id="shopNameArea"></div>
    <div class="display-area" id="displayArea"></div>
    <div id="historyContainer"></div>
    <div class="highlight-box" id="promptText"></div>

    <input type="number" id="ansInput" placeholder="?" autocomplete="off" inputmode="numeric">
    <div id="msg" style="margin: 5px 0; font-weight: bold; min-height: 1.2rem;"></div>
    
    <button class="btn btn-check" id="checkBtn" onclick="verify()">é€å‡ºç­”æ¡ˆ</button>
    <button class="btn btn-next" id="nextBtn" onclick="initGame()">ä¸‹ä¸€é¡Œ âœ</button>
    <button class="btn btn-share" id="shareBtn" onclick="shareToLine()">ğŸ“¢ åˆ†äº«æˆ°ç¸¾çµ¦è¦ªæˆš</button>
</div>

<audio id="sndCorrect" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>
<audio id="sndWrong" src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3"></audio>

<script>
    let user = "", score = 0, combo = 0, seconds = 0, targetAnswer = 0, timerInterval;
    let currentMode = 'mixed', maxItems = 2, mixedStep = 1, mixedTotal = 0, mixedPaid = 0, isMuted = false;

    const shopThemes = [
        { name: "ğŸœ éºµé£Ÿé¤¨", items: [ {n:"ç‰›è‚‰éºµ",p:130,v:20}, {n:"æ’éª¨éºµ",p:110,v:15}, {n:"å°èœ",p:40,v:10}, {n:"è²¢ä¸¸æ¹¯",p:35,v:5} ] },
        { name: "ğŸ³ æ—©é¤åº—", items: [ {n:"æ¼¢å ¡",p:55,v:10}, {n:"ä¸‰æ˜æ²»",p:35,v:5}, {n:"å¥¶èŒ¶",p:25,v:5}, {n:"è›‹é¤…",p:30,v:5} ] },
        { name: "ğŸ¥¤ é£²æ–™åº—", items: [ {n:"çç å¥¶èŒ¶",p:60,v:10}, {n:"ç´…èŒ¶",p:30,v:5}, {n:"ç¶ èŒ¶",p:30,v:5}, {n:"æ°´æœèŒ¶",p:75,v:15} ] },
        { name: "âœï¸ æ–‡å…·åº—", items: [ {n:"ç­†è¨˜æœ¬",p:45,v:10}, {n:"åŸå­ç­†",p:15,v:5}, {n:"ä¿®æ­£å¸¶",p:55,v:10}, {n:"æ©¡çš®æ“¦",p:10,v:2} ] },
        { name: "ğŸ— ç‚¸é›æ”¤", items: [ {n:"é›æ’",p:85,v:10}, {n:"ç”œä¸è¾£",p:30,v:5}, {n:"èŠ±æä¸¸",p:35,v:5}, {n:"å››å­£è±†",p:40,v:10} ] }
    ];

    function fakeLogin() {
        user = document.getElementById('userNameInput').value.trim() || "æŒ‘æˆ°è€…";
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('displayName').innerText = user;
        initGame();
    }

    function adjustMaxItems(v) {
        maxItems = Math.max(1, Math.min(6, maxItems + v));
        document.getElementById('maxItemDisplay').innerText = maxItems;
        initGame();
    }

    function switchMode(m) {
        currentMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + m).classList.add('active');
        initGame();
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    }

    function initGame() {
        clearInterval(timerInterval); seconds = 0; mixedStep = 1;
        document.getElementById('msg').innerText = '';
        document.getElementById('ansInput').value = '';
        document.getElementById('ansInput').disabled = false;
        document.getElementById('checkBtn').style.display = 'block';
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('shareBtn').style.display = 'none';
        document.getElementById('historyContainer').innerHTML = '';
        
        const theme = shopThemes[Math.floor(Math.random()*shopThemes.length)];
        document.getElementById('shopNameArea').innerHTML = `<span class="shop-tag">${theme.name}</span>`;
        
        const display = document.getElementById('displayArea');
        display.innerHTML = '';
        let total = 0;
        const count = Math.floor(Math.random() * maxItems) + 1;

        let selectedItems = [...theme.items].sort(() => 0.5 - Math.random()).slice(0, count);

        selectedItems.forEach(item => {
            const realPrice = item.p + (Math.floor(Math.random() * (item.v / 5 + 1)) * 5);
            // ä¿®æ­£è™•ï¼šæ‰¾é›¶ç·´ç¿’ç¾åœ¨ä¹Ÿæœƒéš¨æ©Ÿ 1-3 å€æ•¸é‡ (å¦‚æœæ˜¯ç¶œåˆæ¨¡å¼å‰‡æ›´å»£)
            const q = (Math.floor(Math.random() * 3) + 1); 
            display.innerHTML += `<div class="item-row"><span>${item.n} ($${realPrice})</span><span>x ${q}</span></div>`;
            total += (realPrice * q);
        });

        if (currentMode === 'calc') {
            document.getElementById('promptText').innerText = `ç¸½å…±å¤šå°‘éŒ¢ï¼Ÿ`;
            targetAnswer = total;
        } else {
            let paid = 0;
            if (total <= 100) paid = 100;
            else if (total <= 500) paid = 500;
            else paid = 1000;
            // ç¢ºä¿é¡§å®¢ä»˜çš„éŒ¢ä¸€å®šæ¯”ç¸½åƒ¹å¤š
            while (paid < total) {
                paid += 500;
            }

            if (currentMode === 'change') {
                display.innerHTML += `<div style="text-align:right; font-weight:bold; color:red; border-top:1px solid #ccc;">æ‡‰æ”¶ $${total}</div>`;
                document.getElementById('promptText').innerText = `å®¢ä»˜ ${paid}ï¼Œæ‰¾å¤šå°‘ï¼Ÿ`;
                targetAnswer = paid - total;
            } else {
                mixedTotal = total;
                mixedPaid = paid;
                document.getElementById('promptText').innerText = `Step 1: å…ˆç®—ç¸½åƒ¹`;
                targetAnswer = mixedTotal;
            }
        }

        timerInterval = setInterval(() => { seconds++; document.getElementById('seconds').innerText = seconds; }, 1000);
        document.getElementById('ansInput').focus();
    }

    function verify() {
        const val = parseInt(document.getElementById('ansInput').value);
        if(isNaN(val)) return;

        if (currentMode === 'mixed' && mixedStep === 1) {
            if (val === targetAnswer) {
                if(!isMuted) document.getElementById('sndCorrect').play();
                mixedStep = 2;
                document.getElementById('historyContainer').innerHTML = `<div class="history-info">âœ… ç¸½åƒ¹ç¢ºèªï¼š$${mixedTotal}</div>`;
                document.getElementById('ansInput').value = '';
                document.getElementById('promptText').innerText = `Step 2: å®¢ä»˜ ${mixedPaid} æ‰¾å¤šå°‘ï¼Ÿ`;
                targetAnswer = mixedPaid - mixedTotal;
                document.getElementById('ansInput').focus();
            } else fail();
        } else {
            if(val === targetAnswer) success(); else fail();
        }
    }

    function success() {
        if(!isMuted) document.getElementById('sndCorrect').play();
        score++; combo++;
        document.getElementById('msg').style.color = "green";
        document.getElementById('msg').innerText = "âœ… æ­£ç¢ºï¼";
        finishRound();
    }

    function fail() {
        if(!isMuted) document.getElementById('sndWrong').play();
        combo = 0;
        document.getElementById('msg').style.color = "red";
        document.getElementById('msg').innerText = `âŒ ç­”æ¡ˆæ˜¯ ${targetAnswer}`;
        finishRound();
    }

    function finishRound() {
        clearInterval(timerInterval);
        document.getElementById('score').innerText = score;
        document.getElementById('combo').innerText = combo;
        document.getElementById('ansInput').disabled = true;
        document.getElementById('checkBtn').style.display = 'none';
        document.getElementById('nextBtn').style.display = 'block';
        document.getElementById('shareBtn').style.display = 'block';
    }

    function shareToLine() {
        const text = `æˆ‘æ˜¯æ”¶éŠ€ç‹ ${user}ï¼é€£çºŒç­”å° ${score} é¡Œï¼ğŸ”¥ ä½ æ•¢æŒ‘æˆ°å—ï¼Ÿ${window.location.href}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
    }
</script>
</body>
</html>
